// wuw â€“ https://github.com/fasttime/wuw
"use strict";{const e=CSSStyleDeclaration.prototype.item,t=Error,n=t.captureStackTrace,o=JSON.stringify,r=Math.floor,i=Math.max,c=Node.prototype.hasChildNodes,s=Object.create,a=Object.defineProperties,f=Object.defineProperty,u=Object.entries,l=Object.freeze,d=Object.getOwnPropertyDescriptors,w=Object.keys,p=Proxy,g=p.revocable,m=RangeError,h=Reflect.defineProperty,y=Reflect.deleteProperty,b=Reflect.get,k=Reflect.getPrototypeOf,R=Reflect.setPrototypeOf,v=Reflect.set,A=Set,P=String,F=Symbol,L=TypeError,T=console.error,C=console.log,M=console.warn,O="object"==typeof module?require("perf_hooks").performance:performance;function defineConstant(e,t,n){f(e,t,{configurable:!0,value:n})}function defineFunction(e,t,n){f(n,"name",{configurable:!0,value:t}),defineConstant(e,t,n)}function defineVariable(e,t,n,o){f(e,t,{configurable:!0,get:n,set:o})}const{installCallback:$,notify:j,uninstallCallback:x}=(()=>{const e=new A;return{installCallback:function(t){e.add(t)},notify:function(t){for(const n of e)try{n(t)}catch(e){T(e)}},uninstallCallback:function(t){e.delete(t)}}})();let S,U=F();const{unwatchAs:K,watchAs:G}=(()=>{function o({wuwTarget:e}){const t=M.get(e);if(t){if(t.wuwGeneration===U)return!0;P(e,t)}return!1}function r(e,t){const n=k(e);return R(e,k(t)),n}function i(e){try{c.call(e)}catch(e){return!1}return!0}function f(){return O.now()}function m(e,t){const n=d(e),o=w(n).filter(o=>!(n[o].configurable&&y(e,o)||(delete n[o],t.has(o)||(t.add(o),0))));return o.length&&S&&S(e,o),n}function P(e,{mirror:t,revoke:n}){n(),function(e,t){const n=u(t);for(const[t,o]of n)h(e,t,o)}(e,d(t)),R(e,k(t)),M.delete(e)}const F={get:function(e,t,n){const r=C.get(e);return r&&r.spy===n&&(o(r),n=e),b(e,t,n)},set:function e(t,n,r,i){const c=C.get(t);return c&&c.spy===i?(o(c)?function(t,n,o){const r={target:t,propertyKey:n,stackTrace:$(e),startTime:f()};let i,c;try{i=v(t,n,o),r.success=i}catch(e){c=e,r.error=c}if(r.endTime=f(),l(r),j(r),void 0!==c)throw c;return i}:v)(t,n,r):v(t,n,r,i)}},T={get:function(t,n,o){const i=M.get(o);if(i&&t===i.mirror){if(i.wuwGeneration===U)return function(t,n,o){const i=r(o,t);let c;try{c=b(t,n,o)}finally{R(o,i)}return function(t,n,o){if("style"===n&&function(t){try{e.call(t,-1)}catch(e){return!1}return!0}(o)){let e=C.get(o);if(e)o=e.spy;else{const n=new p(o,F);e={spy:n,wuwTarget:t},C.set(o,e),o=n}}return o}(o,n,c)}(t,n,o);P(o,i)}return b(t,n,o)},set:function e(t,n,o,i){const c=M.get(i);if(c&&t===c.mirror){if(c.wuwGeneration===U)return function({remarkedPropertyKeys:t},n,o,i,c){const s={target:c,propertyKey:o,stackTrace:$(e),startTime:f()},u=r(c,n);let d,w;try{d=v(n,o,i,c),s.success=d}catch(e){w=e,s.error=w}const p=m(c,t);if(a(n,p),R(c,u),s.endTime=f(),l(s),j(s),void 0!==w)throw w;return d}(c,t,n,o,i);P(i,c)}return v(t,n,o,i)}},C=new WeakMap,M=new WeakMap,$=(()=>{const e=n?e=>{const t={};return n(t,e),t.stack.replace(/^.{5}\n/,"")}:()=>t().stack.replace(/^(Error\n)?(?:.*\n){4}/,"");return"stackTraceLimit"in t?n=>{const{stackTraceLimit:o}=t;t.stackTraceLimit=1/0;const r=e(n);return t.stackTraceLimit=o,r}:t=>e(t)})();return{unwatchAs:function(e,t){if(void 0===t)throw L(`Argument of ${e} is missing or undefined`);if(!i(t))throw L(`Argument of ${e} does not implement interface Node`);const n=M.get(t);return n&&P(t,n),N},watchAs:function(e,t){if(void 0===t)throw L(`Argument of ${e} is missing or undefined`);if(!i(t))throw L(`Argument of ${e} does not implement interface Node`);const n=M.get(t);if(!n||n.wuwGeneration!==U){n&&P(t,n);const e=new A,o=m(t,e),r=s(k(t),o),{proxy:i,revoke:c}=g(r,T);R(t,i),M.set(t,{mirror:r,remarkedPropertyKeys:e,revoke:c,wuwGeneration:U})}return N}}})(),N=e=>G("wuw",e),E={};defineConstant(N,"watching",E),defineFunction(N,"watch",e=>G("wuw.watch",e)),defineFunction(N,"unwatch",e=>K("wuw.unwatch",e)),defineFunction(E,"watch",e=>G("wuw.watching.watch",e)),defineFunction(E,"unwatch",e=>K("wuw.watching.unwatch",e)),defineFunction(E,"unwatchAll",()=>(U=F(),N)),defineFunction("undefined"==typeof self?global:self,"wuw",N);{function formatList(e){let t="",n=0;for(let o=e.length;--o>=0;){switch(n++){case 0:break;case 1:t=` and ${t}`;break;default:t=`, ${t}`}t=e[o]+t}return t}function formatPropertyKey(e){return("string"==typeof e?o:P)(e)}function getRemarkUndeletableProperties(){return S}function setRemarkUndeletableProperties(e){if(void 0!==e&&null!==e&&"function"!=typeof e)throw L("remarkUndeletableProperties must be a function, undefined or null");S=e||null}defineConstant(E,"defaultRemarkUndeletableProperties",S=((e,t)=>{const n=formatList(t.map(formatPropertyKey));M("The target object %o has undeletable properties: %s",e,n)})),defineVariable(E,"remarkUndeletableProperties",getRemarkUndeletableProperties,setRemarkUndeletableProperties)}function doAs(e,t){if(void 0===t)throw L(`Argument of ${e} is missing or undefined`);if("function"!=typeof t)throw L(`Argument of ${e} is not a function`);return $(t),N}function dontAs(e,t){if(void 0===t)throw L(`Argument of ${e} is missing or undefined`);if("function"!=typeof t)throw L(`Argument of ${e} is not a function`);return x(t),N}const I={};defineConstant(N,"doing",I),defineFunction(N,"do",e=>doAs("wuw.do",e)),defineFunction(N,"dont",e=>dontAs("wuw.dont",e)),defineFunction(I,"do",e=>doAs("wuw.doing.do",e)),defineFunction(I,"dont",e=>dontAs("wuw.doing.dont",e));{let e=0;const t=1e4,n=[],o=()=>{e=0,n.splice(0,1/0)};function getMaxRecords(){return t}function*log(){for(;e<n.length;)yield n[e++]}function logRecord(o){n.length>=t&&(e&&--e,n.shift()),n.push(o)}function setMaxRecords(o){if((o=+o)<0||o!==r(o))throw m("Invalid number of records");t=o+0;const c=n.length-t;c>0&&(e=i(e-c,0),n.splice(0,c))}const c=()=>n.slice();$(logRecord),defineFunction(N,"clear",o),defineConstant(N,"defaultMaxRecords",t),defineFunction(N,"log",log),defineVariable(N,"maxRecords",getMaxRecords,setMaxRecords),defineFunction(N,"snapshot",c)}{let e=null;const t="undefined"!=typeof setImmediate?()=>void setImmediate(printLiveRecords):(()=>{const{port1:e,port2:t}=new MessageChannel;return e.onmessage=printLiveRecords,()=>t.postMessage()})(),n=()=>(x(printLiveRecordLater),N),o=()=>($(printLiveRecordLater),N);function printLiveRecordLater(n){e?e.push(n):(e=[n],t())}function printLiveRecords(){for(;;){const t=e.shift();if(!t)break;C("wuw record\n%o",t)}e=null}{const e=()=>o();defineFunction(e,"on",o),defineFunction(e,"off",n),defineFunction(N,"live",e)}}}